<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Stadium Weather Table</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #234889;
            color: #222;
            padding: 15px;
        }
        #main-title {
            text-align: center;
            color: #f2f2f2;
            margin-bottom: 24px;
        }
        #nav {
            text-align: center;
            margin-bottom: 14px;
        }
        #nav a {
            color: #e2e8f0;
            margin: 0 10px;
            font-size: 0.95rem;
        }
        .date-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            background: #fafbfc;
            padding: 12px;
            border-radius: 9px;
            box-shadow: 0 2px 5px #aaa7;
        }

        .date-bar button:first-child {
            margin-left: 0;
            margin-right: auto;
        }

        .date-bar button:last-child {
            margin-left: auto;
            margin-right: 0;
        }

        #dt-spot {
            font-weight: bold;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        #wr-sum {
            color: #f8f9fa; /* Light color for good contrast on dark blue background */
            font-weight: 600;
            font-size: 1rem;
            margin-top: 6px;
            
        }



        .view-btn, .effect-btn {
            background: #234889;
            color: #fff;
            border: 2px solid #fff;
            border-radius: 25px;        
            padding: 12px 32px;         
            margin: 8px 6px;
            font-size: 1rem;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(30,52,138,0.09);
            transition: background 0.18s, box-shadow 0.18s;
            cursor: pointer;
        }
        .view-btn:hover, .effect-btn:hover {
            background: #325baa;
            color: #fff;
            box-shadow: 0 4px 16px rgba(30,52,138,0.16);
        }

        
        .view-btn.active, .effect-btn.active {
            background: #fff;
            color: #234889;
            border: 2px solid #234889;
            box-shadow: 0 0 0 3px rgba(30,52,138,0.22);
        }
        .games-area, .teams-area {
            background: #fff;
            border-radius: 7px;
            box-shadow: 0 1px 4px #9999;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.97rem;
        }
        th, td {
            padding: 10px 6px;
            text-align: center;
            border-bottom: 1px solid #d3d3d3;
        }
        th {
            background: #3569b3;
            color: #fff;
        }
        .gamecell {
            min-width: 180px;
            text-align: left;
        }
        .factor-plus { color: #217624; font-weight: bold; }
        .factor-minus { color: #b22d2d; font-weight: bold; }
        .factor-flat { color: #6a7a89; }
        .dome-ind { background: #22a055; color: #fff; border-radius: 7px; padding: 2px 6px; font-size: 0.72rem; }
        .fade-row { background: #f9f6e7; border-left: 4px solid #fed972; }
        .sep-row { background: #e2edff; color: #6c757d; font-weight: bold; }
        .loading-txt { text-align: center; color: #666; padding: 30px; }
        .error-txt { background: #ffebeb; color: #c00; padding: 21px; border-radius: 7px; }
        /* Responsive patchy styles */
        @media (max-width: 730px) {
            th, td { padding: 5px 2px; font-size: 0.83rem; }
            .gamecell { min-width: 130px; }
            #main-title { font-size: 1.6rem; }
            .view-btn, .effect-btn { font-size: 0.84rem; padding: 6px 9px;}
        }
    </style>
</head>
<body>
    <div>
        <div id="main-title"><h1>NFL Stadium Weather Table</h1></div>
        <div class="date-bar">
            <button onclick="dateChange(-1)" class="view-btn" style="margin-right:18px;">&#60;&#60; Prev</button>
            <span style="font-weight: bold; font-size: 1.25rem;" id="dt-spot">September 9, 2025</span>
            <button onclick="dateChange(1)" class="view-btn" style="margin-left:18px;">Next &#62;&#62;</button>
        </div>
        <div style="margin-top:6px;margin-bottom:6px;">
            <span id="wr-sum">Loading stadium weather info...</span>
            <span id="last-changed" style="font-size:0.95rem;color:#666;float:right;"></span>
        </div>
        <div id="nav">
            <a href="#">Weather Guide</a> | <a href="#">Stadium Factors</a>
        </div>
        <div style="text-align:center; margin-bottom:12px;">
            <button class="view-btn active" onclick="setView('default')">Table view</button>
            <button class="view-btn" onclick="setView('team')">Team Weather</button>
            <button class="view-btn" onclick="setView('pos')">Units</button>
            <button class="view-btn" onclick="setView('alert')">Matchup Alert</button>
        </div>
        <div style="text-align:center;margin-bottom:14px;">
            <button class="effect-btn active" onclick="setEffect('all')">Weather adjusted</button>
            <button class="effect-btn" onclick="setEffect('stad')">Base stadium only</button>
            <button class="effect-btn" onclick="setEffect('wthr')">Weather impact only</button>
        </div>
        <div class="games-area">
            <table id="tbl-main">
                <thead id="tbl-head"></thead>
                <tbody id="tbl-body">
                    <tr><td colspan="5" class="loading-txt">Loading stadium factors...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <script>
        var currentView = 'default', currentEffect = 'all';
        var sf_data = null;
        var teamsRef = {
            "Lambeau Field": { h: "GB", a: "CHI" }, "Soldier Field": { h: "CHI", a: "GB" },
            "Cleveland Browns Stadium": { h: "CLE", a: "PIT" }, "Heinz Field": { h: "PIT", a: "BAL" },
            "M&T Bank Stadium": { h: "BAL", a: "CIN" }, "MetLife Stadium": { h: "NYG", a: "WAS" },
            "Gillette Stadium": { h: "NE", a: "BUF" }, "Hard Rock Stadium": { h: "MIA", a: "NYJ" },
            "TIAA Bank Field": { h: "JAX", a: "TEN" }, "Empower Field": { h: "DEN", a: "LV" },
            "Lumen Field": { h: "SEA", a: "ARI" }, "Levi's Stadium": { h: "SF", a: "SEA" },
            "Raymond James Stadium": { h: "TB", a: "CAR" }, "NRG Stadium": { h: "HOU", a: "IND" },
            "Lucas Oil Stadium": { h: "IND", a: "JAX" }, "Allegiant Stadium": { h: "LV", a: "LAC" },
            "SoFi Stadium": { h: "LAR", a: "SF" }, "State Farm Stadium": { h: "ARI", a: "LAR" },
            "AT&T Stadium": { h: "DAL", a: "PHI" }, "U.S. Bank Stadium": { h: "MIN", a: "DET" },
            "Ford Field": { h: "DET", a: "MIN" }, "Mercedes-Benz Superdome": { h: "NO", a: "ATL" },
            "Mercedes-Benz Stadium": { h: "ATL", a: "NO" }
        };

        function setView(v) {
            currentView = v;
            document.querySelectorAll('.view-btn').forEach(function(b){b.classList.remove('active')});
            if(v=='default') document.querySelector('.view-btn').classList.add('active');
            else if(v=='team') document.querySelectorAll('.view-btn')[1].classList.add('active');
            else if(v=='pos') document.querySelectorAll('.view-btn')[2].classList.add('active');
            else document.querySelectorAll('.view-btn')[3].classList.add('active');
            refreshTbl();
        }
        function setEffect(e) {
            currentEffect = e;
            var btns = document.querySelectorAll('.effect-btn');
            btns.forEach(function(b){b.classList.remove('active')});
            if(e=='all') btns[0].classList.add('active');
            else if(e=='stad') btns[1].classList.add('active');
            else btns[2].classList.add('active');
            refreshTbl();
        }
        function dateChange(i) {
            // Date navigation logic here if implemented
            alert('Date navigation not yet coded');
        }
        function formatPct(f) {
            var pct = Math.round((f-1)*100);
            return (pct>0?'+':'') + pct + '%';
        }
        function formatDiff(df) {
            var pct = Math.round(df*100);
            return Math.abs(pct)<1 ? '0%' : (pct>0?'+':'')+pct+'%';
        }
        function getClass(val) {
            if(val>1.05) return 'factor-plus';
            if(val<0.95) return 'factor-minus';
            return 'factor-flat';
        }
        function refreshTbl() {
            if(!sf_data || !sf_data.stadium_factors) {
                document.getElementById('tbl-body').innerHTML='<tr><td colspan="5" class="loading-txt">Loading stadium factors...</td></tr>';
                return;
            }
            // Table header
            var hd = '';
            if(currentView=='team')
                hd='<tr><th>Matchup</th><th>Home Adv.</th><th>Weather</th><th>Score</th><th>Conditions</th></tr>';
            else if(currentView=='pos')
                hd='<tr><th>Stadium</th><th>Passing</th><th>Rushing</th><th>Kicking</th><th>Defense</th></tr>';
            else if(currentView=='alert')
                hd='<tr><th>Alert</th><th>Teams</th><th>Factor</th><th>Impact</th><th>Note</th></tr>';
            else
                hd='<tr><th>Stadium</th><th>Passing</th><th>Rushing</th><th>Kicking</th><th>Weather</th></tr>';
            document.getElementById('tbl-head').innerHTML=hd;
            // Table body
            var tbC='';
            if(currentView=='team') {
                sf_data.stadium_factors.forEach(function(fact){
                    if(fact.is_dome) return;
                    var adv = fact.team_weather_advantage;
                    if(!adv) return;
                    var tmref = teamsRef[fact.stadium]||{h:"HOME",a:"AWAY"};
                    var cls = adv.advantage_score>108? 'factor-plus' : adv.advantage_score<96?'factor-minus':'factor-flat';
                    tbC += '<tr><td class="gamecell">'+tmref.a+' @ '+tmref.h+'<br><span style="color:#4488dd;font-size:0.90rem;">'+fact.stadium+'</span></td>'
                        +'<td class="'+cls+'">'+Math.round(adv.home_advantage*100)+'%</td>'
                        +'<td style="font-size:0.89rem;">'+adv.weather_narrative+'</td>'
                        +'<td class="'+cls+'">'+adv.advantage_score+'</td>'
                        +'<td style="font-size:0.8rem;">'+fact.weather+'</td></tr>';
                });
            } else if(currentView=='pos') {
                sf_data.stadium_factors.forEach(function(fact){
                    var imp = fact.position_impacts;
                    if(!imp) return;
                    tbC += '<tr><td class="gamecell">'+fact.stadium+'<br><span style="color:#4488dd;font-size:0.90rem;">'+fact.home_team+'</span></td>'
                        +'<td class="'+getClass(imp.passing_offense)+'">'+formatPct(imp.passing_offense)+'</td>'
                        +'<td class="'+getClass(imp.rushing_offense)+'">'+formatPct(imp.rushing_offense)+'</td>'
                        +'<td class="'+getClass(imp.field_goal_unit)+'">'+formatPct(imp.field_goal_unit)+'</td>'
                        +'<td class="'+getClass(imp.defense)+'">'+formatPct(imp.defense)+'</td></tr>';
                });
            } else if(currentView=='alert') {
                var alerts=[];
                sf_data.stadium_factors.forEach(function(fact){
                    if(fact.is_dome) return;
                    var adv = fact.team_weather_advantage;
                    var wth = fact.weather_details;
                    if(!(adv&&wth)) return;
                    if(wth.temp<=32&&adv.advantage_score>=110)
                        alerts.push({ty:"FREEZING ADV",t:fact.home_team+" vs away",f:wth.temp+"F",imp:"HIGH",note:adv.weather_narrative+" (Fumbles up below freezing)",dst:fact.stadium});
                    if(wth.wind>=20)
                        alerts.push({ty:"EXTREME WIND",t:fact.stadium, f:wth.wind+" mph", imp:"SEVERE", note:"FG down to 77% acc,",dst:fact.stadium});
                    else if(wth.wind>=15)
                        alerts.push({ty:"HIGH WIND",t:fact.stadium, f:wth.wind+" mph", imp:"HIGH", note:"Pass/FG reduced.",dst:fact.stadium});
                    if(wth.precipitation=='snow')
                        alerts.push({ty:"SNOW", t:fact.stadium, f:"Snow", imp:"HIGH", note:"Rush/FG up, Pass/Score down.",dst:fact.stadium});
                    else if(wth.precipitation=='rain'&&adv.advantage_score>=105)
                        alerts.push({ty:"RAIN ADV",t:fact.home_team+" vs away",f:"Rain",imp:"MOD",note:"Home team better in wet.",dst:fact.stadium});
                    if(adv.advantage_score>=115)
                        alerts.push({ty:"MAJOR ADV",t:fact.home_team+" vs away",f:adv.weather_factors.join(','),imp:"EXTREME",note:adv.weather_narrative,dst:fact.stadium});
                    else if(adv.advantage_score<=92)
                        alerts.push({ty:"VISITOR ADV",t:"visiting @ "+fact.stadium,f:adv.weather_factors.join(','),imp:"MOD",note:"Visitor handles weather better.",dst:fact.stadium});
                    if(adv.weather_factors&&(adv.weather_factors.indexOf("dome team outdoors")>=0))
                        alerts.push({ty:"DOME OUTSIDE",t:"Visiting dome @ "+fact.stadium,f:"Outdoor",imp:"HIGH",note:"Dome team gets penalty.",dst:fact.stadium});
                });
                if(alerts.length==0)
                    tbC='<tr><td colspan="5" class="loading-txt">No notable weather alerts for these games.</td></tr>';
                else
                    alerts.forEach(function(a){
                        var icls=a.imp=="EXTREME"||a.imp=="SEVERE"?'factor-minus':a.imp=="HIGH"?'factor-flat':'factor-plus';
                        tbC += '<tr><td class="gamecell">'+a.ty+'<br><span style="color:#4488dd;">'+a.dst+'</span></td><td>'+a.t+'</td><td>'+a.f+'</td><td class="'+icls+'">'+a.imp+'</td><td style="font-size:0.83rem;">'+a.note+'</td></tr>';
                    });
            } else {
                // default view
                var odr = false, domr = false;
                sf_data.stadium_factors.forEach(function(fact,idx){
                    var tmref = teamsRef[fact.stadium] || {h:"HOME", a:"AWAY"};
                    var hr = '1:'+(idx%4*15||'00') + ' PM';
                    if(!domr && fact.is_dome && odr) {
                        tbC += '<tr class="sep-row"><td colspan="5">Indoor Stadiums (No Weather Impact)</td></tr>';
                        domr=true;
                    } else if(!odr && !fact.is_dome) odr=true;
                    var f1, f2, f3;
                    if(currentEffect=='all') {
                        f1 = formatPct(fact.passing_factor);
                        f2 = formatPct(fact.rushing_factor);
                        f3 = formatPct(fact.kicking_factor);
                    } else if(currentEffect=='stad') {
                        f1 = formatPct(fact.base_passing_factor);
                        f2 = formatPct(fact.base_rushing_factor);
                        f3 = formatPct(fact.base_kicking_factor);
                    } else {
                        f1 = formatDiff(fact.passing_factor-fact.base_passing_factor);
                        f2 = formatDiff(fact.rushing_factor-fact.base_rushing_factor);
                        f3 = formatDiff(fact.kicking_factor-fact.base_kicking_factor);
                    }
                    var weatherCell = fact.is_dome ? '<span class="dome-ind">DOME</span>' : fact.weather;
                    var addCls = (!fact.is_dome) && (
                        Math.abs(fact.passing_factor-fact.base_passing_factor)>0.01||
                        Math.abs(fact.rushing_factor-fact.base_rushing_factor)>0.01||
                        Math.abs(fact.kicking_factor-fact.base_kicking_factor)>0.01 ) ? 'fade-row':'';
                    tbC += '<tr class="'+addCls+'"><td class="gamecell"><div style="font-weight:bold;color:#234889">'+fact.stadium+'</div>'
                        +'<div>'+tmref.a+' @ '+tmref.h+' '+hr+'</div>'
                        +'<div style="font-size:0.81rem;color:#7ba5c9;">'+(fact.is_dome?'':fact.weather)+'</div></td>'
                        +'<td class="'+getClass(currentEffect=='all'?fact.passing_factor:fact.base_passing_factor)+'">'+f1+'</td>'
                        +'<td class="'+getClass(currentEffect=='all'?fact.rushing_factor:fact.base_rushing_factor)+'">'+f2+'</td>'
                        +'<td class="'+getClass(currentEffect=='all'?fact.kicking_factor:fact.base_kicking_factor)+'">'+f3+'</td>'
    +'<td style="font-size:0.80rem;">'+weatherCell+'</td></tr>';
                });
            }
            document.getElementById('tbl-body').innerHTML=tbC;
        }
        function updateWeatherSummary() {
            if(sf_data && sf_data.stadium_factors) {
                var outdoors = sf_data.stadium_factors.filter(function(x){return !x.is_dome;}).length;
                var domes = sf_data.stadium_factors.length-outdoors;
                var alertCnt = 0;
                sf_data.stadium_factors.forEach(function(f){
                    if(f.is_dome) return;
                    var adv = f.team_weather_advantage;
                    if(adv && adv.advantage_score && (adv.advantage_score>108||adv.advantage_score<96)) alertCnt++;
                });
                document.getElementById('wr-sum').innerText= outdoors+' outdoor stadiums, '+domes+' indoor. '+alertCnt+' possible weather alerts.';
            }
        }
        function updateLastUpdated() {
            if(sf_data && sf_data.last_updated) {
                var dat = new Date(sf_data.last_updated);
                document.getElementById('last-changed').innerText = "Last updated: "+dat.toLocaleTimeString();
            }
        }

        function getData() {
            // Simulate API call
            fetch('/.netlify/functions/stadium-factors')
            .then(function(resp){
                if(!resp.ok) throw Error("HTTP "+resp.status);
                return resp.json();
            })
            .then(function(dt){
                sf_data = dt; updateLastUpdated(); updateWeatherSummary(); refreshTbl();
            })
            .catch(function(e){
                document.getElementById('tbl-body').innerHTML='<tr><td colspan="5" class="error-txt">Error loading stadium data: '+e.message+'</td></tr>';
            });
        }

        document.addEventListener('DOMContentLoaded', function(){
            getData();
            setInterval(getData, 30*60*1000);
        });
    </script>
</body>
</html>
